<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Resultado</title>
  <style>
    :root{--bg:#111;--container-rgba:rgba(0,0,0,0.6);--text:#fff;--title:#eee}
    html,body{height:100%}
    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 10px;
      transition: background-color 0.25s, color 0.25s;
    }

    #capture-area { /* capture-area deve ter position:relative para watermark absolute funcionar */
      position: relative;
    }

    .result-container {
      width: 500px;
      background: var(--container-rgba);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.8);
      transition: background-color 0.3s, background-image 0.3s;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
      overflow: hidden;
    }

    h1 {
      margin-bottom: 20px;
      color: var(--title);
      cursor: text;
      outline: none;
      text-align: center;
      transition: color 0.3s;
      text-shadow: 0 1px 0 rgba(0,0,0,0.4);
    }

    .result {
      display: flex;
      align-items: center;
      margin: 10px 0;
      gap: 6px;
    }

    .percent {
      min-width: 60px;
      text-align: right;
      margin-right: 4px;
      font-weight: bold;
      cursor: text;
    }

    .bar {
      flex: 1;
      height: 8px;
      background-color: rgba(0,0,0,0.35);
      border-radius: 4px;
      overflow: hidden;
      margin-right: 4px;
    }

    .fill {
      height: 100%;
      width: 0%;
      background: limegreen;
      border-radius: 4px;
      transition: width 0.5s ease-in-out, background-color 0.3s;
    }

    .name {
      width: 165px;
      text-align: left;
      cursor: text;
      text-shadow: 0 1px 0 rgba(0,0,0,0.4);
      min-height: 18px;
    }

    .remove-btn {
      background: none;
      border: none;
      color: #f55;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      padding: 0 6px;
    }
    .remove-btn:hover{ color:#ff7777 }

    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .buttons button, .buttons label {
      background-color: #222;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .buttons button:hover, .buttons label:hover{background:#333}

    input[type="file"]{ display:none }

    .color-controls { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; justify-content:center }
    .color-controls label{ font-size:13px; color:#ccc; display:inline-flex; align-items:center; gap:8px }
    .color-controls input[type="color"]{ width:36px; height:26px; padding:0; border:none }

    .hide-during-screenshot{ display:none !important }

    /* marca d'água — estilo padrão, sobreposto no container durante screenshot */
    .wd-watermark {
      position: absolute;
      right: 10px;
      bottom: 8px;
      font-size: 13px;
      opacity: 0.45;
      color: #fff;
      pointer-events: none;
      text-shadow: 0 1px 0 rgba(0,0,0,0.6);
    }
  </style>
</head>
<body>
  <div id="capture-area">
    <div class="result-container" id="results-container">
      <h1 contenteditable="true" id="editable-title">Resultado de [seu nome aqui]</h1>
      <div id="results"></div>
      <!-- watermark será inserida aqui dinamicamente antes do screenshot -->
    </div>
  </div>

  <div class="buttons">
    <button id="addLine">Adicionar linha</button>
    <button id="resetData">Resetar informações</button>
    <button id="resetColors">Resetar cores</button>
    <button id="resetAll">Resetar tudo</button>
    <button id="download">Baixar imagem</button>
  </div>

  <div class="buttons">
    <button id="randomize">Gerar aleatórios</button>
    <button id="ascending">Gerar crescente</button>
    <button id="descending">Gerar decrescente</button>
    <button id="shuffleNames">Embaralhar nomes</button>
  </div>

  <div class="buttons" style="margin-top:8px">
    <label for="bgImageInput">Escolher imagem</label>
    <input id="bgImageInput" type="file" accept="image/*">
    <button id="removeImage">Remover imagem</button>
  </div>

  <div class="color-controls" style="margin-top:12px">
    <label>Fundo <input id="bgColor" type="color" value="#111111"></label>
    <label>Container <input id="containerColor" type="color" value="#000000"></label>
    <label>Texto <input id="textColor" type="color" value="#ffffff"></label>
    <label>Título <input id="titleColor" type="color" value="#eeeeee"></label>
  </div>

  <small style="display:block; text-align:center; color:#aaa; margin-top:10px">
    Observação: imagens muito grandes podem exceder o limite do localStorage (~5MB). Use imagens otimizadas.
  </small>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    // ELEMENTS
    const resultsEl = document.getElementById('results');
    const titleEl = document.getElementById('editable-title');
    const resultsContainer = document.getElementById('results-container');

    const bgColorInput = document.getElementById('bgColor');
    const containerColorInput = document.getElementById('containerColor');
    const textColorInput = document.getElementById('textColor');
    const titleColorInput = document.getElementById('titleColor');

    const bgImageInput = document.getElementById('bgImageInput');
    const removeImageBtn = document.getElementById('removeImage');

    // defaults
    const DEFAULT = {
      title: 'Resultado de [seu nome aqui]',
      colors: {
        bg: '#111111',
        container: 'rgba(0,0,0,0.6)',
        text: '#ffffff',
        title: '#eeeeee',
        backgroundImage: null
      }
    };

    /* ---------------- helpers ---------------- */
    function createLine(percent = '0%', name = 'Item') {
      const div = document.createElement('div');
      div.className = 'result';
      div.innerHTML = `
        <div class="percent" contenteditable="true">${percent}</div>
        <div class="bar"><div class="fill"></div></div>
        <div class="name" contenteditable="true">${name}</div>
        <button class="remove-btn" title="Remover linha">×</button>
      `;
      resultsEl.appendChild(div);
      updateBars(); // immediate
    }

    function updateBars() {
      document.querySelectorAll('.result').forEach(r => {
        const percentEl = r.querySelector('.percent');
        const fill = r.querySelector('.fill');
        let val = parseInt((percentEl.textContent || '').replace('%',''), 10);
        if (isNaN(val)) val = 0;
        val = Math.max(0, Math.min(100, val));
        fill.style.width = val + '%';
        // color rules
        if (val > 80) fill.style.backgroundColor = 'limegreen';
        else if (val > 60) fill.style.backgroundColor = 'yellowgreen';
        else if (val > 40) fill.style.backgroundColor = 'orange';
        else if (val > 20) fill.style.backgroundColor = 'orangered';
        else fill.style.backgroundColor = 'red';
        percentEl.textContent = val + '%'; // normalize
      });
    }

    function saveData() {
      const data = {
        title: titleEl.textContent || DEFAULT.title,
        lines: [],
        colors: {
          bg: bgColorInput.value || DEFAULT.colors.bg,
          container: containerColorInput.value || DEFAULT.colors.container,
          text: textColorInput.value || DEFAULT.colors.text,
          title: titleColorInput.value || DEFAULT.colors.title,
          backgroundImage: resultsContainer.dataset.bgImage || null
        }
      };
      document.querySelectorAll('.result').forEach(r => {
        data.lines.push({
          percent: r.querySelector('.percent').textContent || '0%',
          name: r.querySelector('.name').textContent || ''
        });
      });
      try {
        localStorage.setItem('degeneradoData', JSON.stringify(data));
      } catch (err) {
        // storage fail (imagem muito grande). fallback: remove image and retry save
        console.warn('localStorage.setItem falhou (tamanho?). salvando sem imagem.', err);
        data.colors.backgroundImage = null;
        delete resultsContainer.dataset.bgImage;
        resultsContainer.style.backgroundImage = '';
        localStorage.setItem('degeneradoData', JSON.stringify(data));
      }
    }

    function loadData() {
      const raw = localStorage.getItem('degeneradoData');
      resultsEl.innerHTML = '';
      if (!raw) {
        // first time
        titleEl.textContent = DEFAULT.title;
        for (let i=1;i<=10;i++) createLine('0%','Item '+i);
        applyColors(DEFAULT.colors);
        syncColorInputs();
        saveData();
        return;
      }
      try {
        const data = JSON.parse(raw);
        titleEl.textContent = data.title || DEFAULT.title;
        const lines = Array.isArray(data.lines) && data.lines.length ? data.lines : Array.from({length:10},(_,i)=>({percent:'0%',name:`Item ${i+1}`}));
        lines.forEach(l => createLine(l.percent ?? '0%', l.name ?? ''));
        // colors
        const colors = data.colors || DEFAULT.colors;
        applyColors(colors);
        // backgroundImage handling
        if (colors.backgroundImage) {
          resultsContainer.style.backgroundImage = `url('${colors.backgroundImage}')`;
          resultsContainer.dataset.bgImage = colors.backgroundImage;
        } else {
          resultsContainer.style.backgroundImage = '';
          delete resultsContainer.dataset.bgImage;
        }
        syncColorInputs();
      } catch (err) {
        console.error('Erro carregando dados:', err);
        localStorage.removeItem('degeneradoData');
        loadData();
      }
      updateBars();
    }

    function applyColors(colors) {
      document.body.style.backgroundColor = colors.bg ?? DEFAULT.colors.bg;
      resultsContainer.style.backgroundColor = colors.container ?? DEFAULT.colors.container;
      document.body.style.color = colors.text ?? DEFAULT.colors.text;
      titleEl.style.color = colors.title ?? DEFAULT.colors.title;
      if (colors.backgroundImage) {
        resultsContainer.style.backgroundImage = `url('${colors.backgroundImage}')`;
        resultsContainer.dataset.bgImage = colors.backgroundImage;
      } else {
        resultsContainer.style.backgroundImage = '';
        delete resultsContainer.dataset.bgImage;
      }
    }

    function syncColorInputs() {
      // safe conversion: try computedStyle then fallback to defaults
      const bodyBg = getComputedStyle(document.body).backgroundColor;
      const contBg = getComputedStyle(resultsContainer).backgroundColor;
      const txt = getComputedStyle(document.body).color;
      const ttl = getComputedStyle(titleEl).color;
      bgColorInput.value = rgbToHex(bodyBg) || DEFAULT.colors.bg;
      containerColorInput.value = rgbToHex(contBg) || '#000000';
      textColorInput.value = rgbToHex(txt) || DEFAULT.colors.text;
      titleColorInput.value = rgbToHex(ttl) || DEFAULT.colors.title;
    }

    function rgbToHex(rgb) {
      if (!rgb) return null;
      const m = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!m) return null;
      return '#' + [m[1],m[2],m[3]].map(n => parseInt(n).toString(16).padStart(2,'0')).join('');
    }

    /* ---------------- generation buttons ---------------- */
    document.getElementById('randomize').addEventListener('click', () => {
      document.querySelectorAll('.result').forEach(r => {
        const rnd = Math.floor(Math.random()*101);
        r.querySelector('.percent').textContent = rnd + '%';
      });
      updateBars(); saveData();
    });

    function genRandomArray(length){
      const arr = Array.from({length},()=>Math.floor(Math.random()*101));
      return arr;
    }

    document.getElementById('ascending').addEventListener('click', () => {
      const items = Array.from(document.querySelectorAll('.result'));
      const vals = genRandomArray(items.length).sort((a,b)=>a-b);
      items.forEach((r,i)=> r.querySelector('.percent').textContent = vals[i] + '%');
      updateBars(); saveData();
    });

    document.getElementById('descending').addEventListener('click', () => {
      const items = Array.from(document.querySelectorAll('.result'));
      const vals = genRandomArray(items.length).sort((a,b)=>b-a);
      items.forEach((r,i)=> r.querySelector('.percent').textContent = vals[i] + '%');
      updateBars(); saveData();
    });

    document.getElementById('shuffleNames').addEventListener('click', () => {
      const nameEls = Array.from(document.querySelectorAll('.name'));
      const names = nameEls.map(n=>n.textContent);
      // Fisher-Yates
      for (let i=names.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [names[i],names[j]] = [names[j],names[i]];
      }
      nameEls.forEach((el,i)=> el.textContent = names[i]);
      saveData();
    });

    /* ---------------- image chooser ---------------- */
    bgImageInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = e => {
        const dataUrl = e.target.result;
        // apply as background and store in dataset
        resultsContainer.style.backgroundImage = `url('${dataUrl}')`;
        resultsContainer.dataset.bgImage = dataUrl;
        saveData();
      };
      reader.readAsDataURL(f);
      ev.target.value = '';
    });

    removeImageBtn.addEventListener('click', () => {
      resultsContainer.style.backgroundImage = '';
      delete resultsContainer.dataset.bgImage;
      saveData();
    });

    /* ---------------- add/remove/edit interactions ---------------- */
    document.getElementById('addLine').addEventListener('click', () => {
      createLine('0%','Novo item');
      saveData();
    });

    document.body.addEventListener('click', e => {
      if (e.target.classList.contains('remove-btn')) {
        e.target.closest('.result').remove();
        updateBars(); saveData();
      }
    });

    document.body.addEventListener('input', e => {
      if (e.target.classList.contains('percent') || e.target.classList.contains('name') || e.target === titleEl) {
        updateBars(); saveData();
      }
    });

    /* ---------------- color controls ---------------- */
    bgColorInput.addEventListener('input', e => {
      document.body.style.backgroundColor = e.target.value;
      saveData();
    });
    containerColorInput.addEventListener('input', e => {
      resultsContainer.style.backgroundColor = e.target.value;
      saveData();
    });
    textColorInput.addEventListener('input', e => {
      document.body.style.color = e.target.value;
      saveData();
    });
    titleColorInput.addEventListener('input', e => {
      titleEl.style.color = e.target.value;
      saveData();
    });

    /* ---------------- resets ---------------- */
    document.getElementById('resetData').addEventListener('click', () => {
      // keep colors currently set (read from inputs)
      const saved = JSON.parse(localStorage.getItem('degeneradoData') || '{}');
      const colors = saved.colors || {
        bg: bgColorInput.value || DEFAULT.colors.bg,
        container: containerColorInput.value || DEFAULT.colors.container,
        text: textColorInput.value || DEFAULT.colors.text,
        title: titleColorInput.value || DEFAULT.colors.title,
        backgroundImage: resultsContainer.dataset.bgImage || null
      };
      const data = { title: DEFAULT.title, colors, lines: [] };
      for (let i=1;i<=10;i++) data.lines.push({ percent:'0%', name:`Item ${i}`});
      localStorage.setItem('degeneradoData', JSON.stringify(data));
      loadData();
    });

    document.getElementById('resetColors').addEventListener('click', () => {
      // reset only colors, keep lines/title
      const raw = JSON.parse(localStorage.getItem('degeneradoData') || '{}');
      raw.colors = DEFAULT.colors;
      localStorage.setItem('degeneradoData', JSON.stringify(raw));
      applyColors(DEFAULT.colors); syncColorInputs(); saveData();
    });

    document.getElementById('resetAll').addEventListener('click', () => {
      localStorage.removeItem('degeneradoData');
      loadData();
    });

    /* ---------------- download (fix background black & watermark) ---------------- */
    document.getElementById('download').addEventListener('click', async () => {
      // hide controls during capture
      document.querySelectorAll('.buttons, .remove-btn, .color-controls').forEach(el => el.classList.add('hide-during-screenshot'));

      // create watermark element inside resultsContainer so it will be captured
      const wm = document.createElement('div');
      wm.className = 'wd-watermark';
      wm.textContent = 'Feito no site do DEGE :3';
      resultsContainer.appendChild(wm);

      // html2canvas options:
      // - useCORS true: allow cross-origin images when possible
      // - backgroundColor null: keep actual background (not force black)
      // - scale 2: higher resolution screenshot
      try {
        const canvas = await html2canvas(document.getElementById('capture-area'), {
          useCORS: true,
          backgroundColor: null,
          scale: 2,
          allowTaint: false
        });
        const link = document.createElement('a');
        link.download = 'resultado.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error('Erro ao gerar imagem:', err);
        alert('Falha ao gerar imagem. Se você usou imagem de fundo muito grande, tente usar uma menor.');
      } finally {
        // cleanup watermark and unhide
        wm.remove();
        document.querySelectorAll('.buttons, .remove-btn, .color-controls').forEach(el => el.classList.remove('hide-during-screenshot'));
      }
    });

    // init
    loadData();
    // sync inputs after paint
    setTimeout(syncColorInputs, 120);
  </script>
</body>
</html>
